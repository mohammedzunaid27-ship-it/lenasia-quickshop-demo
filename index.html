<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Lenasia Market | Sheet-to-Shop</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#f97316">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        industrial: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            800: '#1f2937',
                            900: '#111827',
                        },
                        accent: {
                            500: '#f97316', // Orange-500
                            600: '#ea580c',
                        }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Loader Animation */
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Animation */
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 0.3s ease-in; }

        /* Hide Number Input Arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-industrial-50 text-industrial-900 font-sans h-screen flex flex-col overflow-hidden">

    <!-- CONFIGURATION SCRIPT -->
    <script>
        /**
         * CONFIGURATION
         * Replace SHEET_URL with your published Google Sheet CSV link.
         * Expected Columns: Name, Category, Price, Image, Description
         */
        const SHEET_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vR-kfOr1fxGM-TTjzTKX5luhrIA3ejigYuj_NzoDf7VXcqyYED-jWaEbxKxEutN0im65GkuJhkwfc5O/pub?output=csv'; 
        
        // The WhatsApp number (South Africa format without +)
        const WA_PHONE = '27633546954'; 
        
        // Fallback Image if URL is broken/missing
        const PLACEHOLDER_IMG = 'https://placehold.co/400x400/1f2937/FFF?text=No+Image';
    </script>

    <!-- HEADER -->
    <header class="bg-white shadow-sm z-20 flex-none">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-warehouse text-accent-500 text-xl"></i>
                <h1 class="font-bold text-lg tracking-tight text-industrial-900">LENASIA<span class="text-accent-500">MARKET</span></h1>
            </div>
            <button onclick="toggleCart()" class="relative p-2 rounded-full hover:bg-gray-100 transition">
                <i class="fa-solid fa-cart-shopping text-xl text-industrial-800"></i>
                <span id="cart-count" class="absolute top-0 right-0 bg-accent-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
            </button>
        </div>
    </header>

    <!-- SEARCH & FILTER BAR -->
    <div class="bg-white border-b border-gray-200 px-4 py-3 flex-none">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-3">
            <div class="relative flex-grow">
                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="search-input" placeholder="Search products..." class="w-full pl-10 pr-4 py-2 bg-gray-100 border-none rounded-lg focus:ring-2 focus:ring-accent-500 focus:outline-none">
            </div>
            <select id="category-filter" class="px-4 py-2 bg-gray-100 rounded-lg focus:ring-2 focus:ring-accent-500 outline-none border-none">
                <option value="All">All Categories</option>
                <!-- Options populated dynamically -->
            </select>
        </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <main id="main-container" class="flex-grow overflow-y-auto p-4 relative">
        <!-- Loader -->
        <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center bg-industrial-50 z-10">
            <div class="loader mb-4"></div>
            <p class="text-gray-500 text-sm animate-pulse">Fetching Inventory...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden flex flex-col items-center justify-center h-full text-center">
            <i class="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-2"></i>
            <h3 class="text-lg font-bold">Connection Error</h3>
            <p class="text-gray-500 mb-4 text-sm">Could not load the shop data.</p>
            <button onclick="initApp()" class="bg-industrial-900 text-white px-4 py-2 rounded shadow">Retry</button>
        </div>

        <!-- Product Grid -->
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-w-7xl mx-auto pb-20">
            <!-- Products injected here -->
        </div>
    </main>

    <!-- CART MODAL (Slide-over) -->
    <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity" onclick="toggleCart()"></div>
    <div id="cart-panel" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 flex flex-col">
        
        <!-- Cart Header -->
        <div class="px-4 py-4 border-b border-gray-100 flex justify-between items-center bg-industrial-50">
            <h2 class="font-bold text-lg"><i class="fa-solid fa-basket-shopping mr-2 text-accent-500"></i>Your Cart</h2>
            <button onclick="toggleCart()" class="text-gray-500 hover:text-red-500 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <!-- Cart Items -->
        <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-4">
            <!-- Cart items injected here -->
            <div class="text-center text-gray-400 mt-10">
                <i class="fa-solid fa-cart-arrow-down text-4xl mb-2 opacity-50"></i>
                <p>Your cart is empty.</p>
            </div>
        </div>

        <!-- Cart Footer -->
        <div class="p-4 border-t border-gray-100 bg-industrial-50">
            <div class="flex justify-between items-center mb-4 text-lg font-bold">
                <span>Total</span>
                <span id="cart-total">R 0.00</span>
            </div>
            <button onclick="checkoutWhatsApp()" class="w-full bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold py-3 rounded-lg shadow-md flex items-center justify-center gap-2 transition transform active:scale-95">
                <i class="fa-brands fa-whatsapp text-xl"></i> Order on WhatsApp
            </button>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-industrial-900 text-white px-6 py-3 rounded-full shadow-lg z-50 flex items-center gap-3 transition-all duration-300 translate-y-20 opacity-0">
        <i class="fa-solid fa-check-circle text-accent-500"></i>
        <span id="toast-msg">Item added</span>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- STATE MANAGEMENT ---
        let inventory = [];
        let cart = {}; // Object with ID as key: { ...product, qty }
        let categories = new Set();

        // --- DOM ELEMENTS ---
        const grid = document.getElementById('product-grid');
        const loader = document.getElementById('loader');
        const errorState = document.getElementById('error-state');
        const searchInput = document.getElementById('search-input');
        const catFilter = document.getElementById('category-filter');
        const cartCountEl = document.getElementById('cart-count');
        const cartItemsEl = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const cartPanel = document.getElementById('cart-panel');
        const cartOverlay = document.getElementById('cart-overlay');

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', initApp);

        async function initApp() {
            try {
                // Reset State
                loader.classList.remove('hidden');
                errorState.classList.add('hidden');
                grid.innerHTML = '';
                
                // Fetch Data
                const csvData = await fetchCSV(SHEET_URL);
                inventory = parseCSV(csvData);

                if (inventory.length === 0) throw new Error("Empty Data");

                // Extract Categories
                categories.add('All');
                inventory.forEach(p => {
                    if(p.category) categories.add(p.category);
                });
                populateCategories();

                // Render
                renderProducts(inventory);
                loadCart(); // Load from LocalStorage if exists
                
            } catch (err) {
                console.error("App Init Error:", err);
                errorState.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- DATA FETCHING & PARSING ---
        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.text();
        }

        function parseCSV(str) {
            // Robust CSV Regex parsing to handle quoted strings containing commas
            const rows = [];
            const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
            const headers = [];
            
            // First pass: get raw array
            let arr = [];
            let matches = null;
            while ((matches = regex.exec(str)) !== null) {
                let match = matches[1];
                if (match.length && match[0] === '"') {
                    match = match.substring(1, match.length - 1).replace(/""/g, '"');
                }
                arr.push(match);
            }

            // Split into rows based on assumption of 5 columns (Name, Category, Price, Image, Desc)
            // Note: This logic assumes the CSV is well formed. 
            // Better approach for strict CSV: Split by newline first, then parse line by line.
            
            const lines = str.split(/\r?\n/).filter(line => line.trim() !== '');
            if(lines.length < 2) return [];

            const keys = lines[0].split(',').map(k => k.trim().toLowerCase());
            
            // Helper to clean CSV line split
            const splitLine = (line) => {
                let result = [];
                let current = '';
                let inQuotes = false;
                for(let i=0; i<line.length; i++) {
                    let char = line[i];
                    if(char === '"') { inQuotes = !inQuotes; continue; }
                    if(char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }

            for(let i = 1; i < lines.length; i++) {
                const values = splitLine(lines[i]);
                if(values.length < keys.length) continue; // Skip malformed rows

                let obj = {
                    id: i, // simple ID
                    name: values[0] || 'Unknown Item',
                    category: values[1] || 'Uncategorized',
                    price: parseFloat(values[2]) || 0,
                    image: values[3] || '',
                    desc: values[4] || ''
                };

                // EDGE CASE: Fix Google Drive Links
                if(obj.image.includes('drive.google.com')) {
                    obj.image = obj.image.replace(/\/open\?/, '/uc?export=view&');
                }
                
                rows.push(obj);
            }
            return rows;
        }

        // --- RENDERING ---
        function renderProducts(products) {
            grid.innerHTML = '';
            
            if(products.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">No products found.</div>';
                return;
            }

            products.forEach(p => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow flex flex-col h-full";
                
                // Resilience: Image Error Handling
                const imgUrl = p.image && p.image.length > 5 ? p.image : PLACEHOLDER_IMG;
                
                card.innerHTML = `
                    <div class="relative w-full pt-[75%] bg-gray-200">
                        <img src="${imgUrl}" alt="${p.name}" 
                             class="absolute top-0 left-0 w-full h-full object-cover"
                             onerror="this.onerror=null;this.src='${PLACEHOLDER_IMG}';">
                        ${p.price === 0 ? '<span class="absolute top-2 right-2 bg-gray-800 text-white text-xs px-2 py-1 rounded">POR</span>' : ''}
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <div class="text-xs text-accent-500 font-semibold mb-1 uppercase tracking-wider">${p.category}</div>
                        <h3 class="font-bold text-gray-900 leading-tight mb-2">${p.name}</h3>
                        <p class="text-xs text-gray-500 line-clamp-2 mb-4 flex-grow">${p.desc}</p>
                        <div class="flex justify-between items-center mt-auto pt-3 border-t border-gray-100">
                            <span class="text-lg font-bold text-gray-900">${formatCurrency(p.price)}</span>
                            <button onclick="addToCart(${p.id})" class="bg-gray-100 hover:bg-accent-500 hover:text-white text-gray-900 w-10 h-10 rounded-full flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function populateCategories() {
            catFilter.innerHTML = '';
            categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                catFilter.appendChild(opt);
            });
        }

        // --- CART LOGIC ---
        function addToCart(id) {
            const product = inventory.find(p => p.id === id);
            if (!product) return;

            if (cart[id]) {
                cart[id].qty++;
            } else {
                cart[id] = { ...product, qty: 1 };
            }
            
            saveCart();
            updateCartUI();
            showToast(`Added ${product.name}`);
        }

        function removeFromCart(id) {
            if (cart[id]) {
                delete cart[id];
                saveCart();
                updateCartUI();
            }
        }

        function changeQty(id, delta) {
            if (cart[id]) {
                cart[id].qty += delta;
                if (cart[id].qty <= 0) delete cart[id];
                saveCart();
                updateCartUI();
            }
        }

        function updateCartUI() {
            const items = Object.values(cart);
            const totalQty = items.reduce((sum, item) => sum + item.qty, 0);
            const totalPrice = items.reduce((sum, item) => sum + (item.price * item.qty), 0);

            // Badge
            cartCountEl.textContent = totalQty;
            cartCountEl.classList.toggle('hidden', totalQty === 0);

            // Total
            cartTotalEl.textContent = formatCurrency(totalPrice);

            // Items List
            if (items.length === 0) {
                cartItemsEl.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <i class="fa-solid fa-cart-arrow-down text-4xl mb-2 opacity-50"></i>
                        <p>Your cart is empty.</p>
                    </div>`;
            } else {
                cartItemsEl.innerHTML = items.map(item => `
                    <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-lg">
                        <img src="${item.image || PLACEHOLDER_IMG}" class="w-12 h-12 object-cover rounded bg-white" onerror="this.src='${PLACEHOLDER_IMG}'">
                        <div class="flex-grow">
                            <h4 class="font-bold text-sm text-gray-800 line-clamp-1">${item.name}</h4>
                            <div class="text-xs text-gray-500">${formatCurrency(item.price)} each</div>
                        </div>
                        <div class="flex items-center gap-2 bg-white rounded border border-gray-200 px-1">
                            <button onclick="changeQty(${item.id}, -1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-red-500"><i class="fa-solid fa-minus text-xs"></i></button>
                            <span class="text-sm font-semibold w-4 text-center">${item.qty}</span>
                            <button onclick="changeQty(${item.id}, 1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-green-500"><i class="fa-solid fa-plus text-xs"></i></button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleCart() {
            const isOpen = !cartPanel.classList.contains('translate-x-full');
            if (isOpen) {
                cartPanel.classList.add('translate-x-full');
                cartOverlay.classList.add('hidden');
            } else {
                cartPanel.classList.remove('translate-x-full');
                cartOverlay.classList.remove('hidden');
            }
        }

        // --- CHECKOUT LOGIC ---
        function checkoutWhatsApp() {
            const items = Object.values(cart);
            if (items.length === 0) return;

            let message = "*New Order from Sheet-to-Shop PWA*\n\n";
            let grandTotal = 0;

            items.forEach(item => {
                const subtotal = item.price * item.qty;
                grandTotal += subtotal;
                message += `${item.qty} x ${item.name} (R${subtotal.toFixed(2)})\n`;
            });

            message += `\n*Total Estimate: R ${grandTotal.toFixed(2)}*`;
            message += `\n\nPlease confirm availability.`;

            const url = `https://wa.me/${WA_PHONE}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // --- HELPERS ---
        function formatCurrency(num) {
            return 'R ' + (num || 0).toFixed(2);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.textContent = msg;
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 2000);
        }

        function saveCart() {
            localStorage.setItem('lenasia_cart', JSON.stringify(cart));
        }

        function loadCart() {
            const saved = localStorage.getItem('lenasia_cart');
            if (saved) {
                cart = JSON.parse(saved);
                updateCartUI();
            }
        }

        // --- EVENT LISTENERS ---
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const category = catFilter.value;
            filterData(term, category);
        });

        catFilter.addEventListener('change', (e) => {
            const term = searchInput.value.toLowerCase();
            const category = e.target.value;
            filterData(term, category);
        });

        function filterData(term, category) {
            const filtered = inventory.filter(p => {
                const matchesTerm = p.name.toLowerCase().includes(term) || p.desc.toLowerCase().includes(term);
                const matchesCat = category === 'All' || p.category === category;
                return matchesTerm && matchesCat;
            });
            renderProducts(filtered);
        }

    </script>
</body>
</html>
<!-- Updated: 2025-12-15 12:00:00 UTC -->
name: Cache Control
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy with no-cache
        run: |
          echo "index.html" >> _config.yml

